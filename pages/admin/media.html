<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°¤ëŸ¬ë¦¬ ê´€ë¦¬ - J-Violin ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="../../css/admin.css">
</head>
<body class="admin-dashboard">
    <header class="admin-header">
        <nav class="admin-nav">
            <h1>ğŸ¼ J-Violin ê´€ë¦¬ì</h1>
            <ul class="admin-nav-menu">
                <li><a href="./dashboard.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="./users.html">ì‚¬ìš©ì ê´€ë¦¬</a></li>
                <li><a href="./schedules.html">ì‹œê°„í‘œ ê´€ë¦¬</a></li>
                <li><a href="./posts.html">ê²Œì‹œíŒ ê´€ë¦¬</a></li>
                <li><a href="./media.html" class="active">ê°¤ëŸ¬ë¦¬ ê´€ë¦¬</a></li>
                <li><a href="./reservations.html">ì˜ˆì•½ ê´€ë¦¬</a></li>
            </ul>
            <div class="admin-user-info">
                <span id="adminUserName">ê´€ë¦¬ì</span>
                <button class="admin-btn admin-btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </nav>
    </header>

    <main class="admin-container">
        <div class="admin-page-header">
            <h1 class="admin-page-title">ê°¤ëŸ¬ë¦¬ ê´€ë¦¬</h1>
            <button class="admin-btn admin-btn-primary" onclick="showUploadModal()">íŒŒì¼ ì—…ë¡œë“œ</button>
        </div>

        <!-- í•„í„° -->
        <div class="admin-filters">
            <div class="filter-group">
                <label for="typeFilter">íƒ€ì…:</label>
                <select id="typeFilter" onchange="filterMedia()">
                    <option value="">ì „ì²´</option>
                    <option value="image">ì´ë¯¸ì§€</option>
                    <option value="video">ë™ì˜ìƒ</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchInput">ê²€ìƒ‰:</label>
                <input type="text" id="searchInput" placeholder="íŒŒì¼ëª… ë˜ëŠ” ì„¤ëª… ê²€ìƒ‰" onkeyup="filterMedia()">
            </div>
        </div>

        <!-- ê°¤ëŸ¬ë¦¬ ê·¸ë¦¬ë“œ -->
        <div class="gallery-grid" id="mediaGrid">
            <div style="text-align: center; color: #666; grid-column: 1 / -1;">ë¡œë”© ì¤‘...</div>
        </div>
    </main>

    <!-- íŒŒì¼ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>íŒŒì¼ ì—…ë¡œë“œ</h2>
                <span class="close" onclick="closeUploadModal()">&times;</span>
            </div>
            <form id="uploadForm" onsubmit="uploadFile(event)">
                <div class="form-group">
                    <label for="fileInput">íŒŒì¼ ì„ íƒ:</label>
                    <input type="file" id="fileInput" accept="image/*,video/*" required>
                    <small>ì§€ì› í˜•ì‹: JPG, PNG, GIF, WebP, MP4, MPEG, QuickTime, AVI (ìµœëŒ€ 100MB)</small>
                </div>
                <div class="form-group">
                    <label for="modalDescription">ì„¤ëª…:</label>
                    <textarea id="modalDescription" rows="3" placeholder="íŒŒì¼ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="admin-btn admin-btn-secondary" onclick="closeUploadModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="admin-btn admin-btn-primary">ì—…ë¡œë“œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë¯¸ë””ì–´ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="mediaModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="mediaModalTitle">ë¯¸ë””ì–´ ì •ë³´</h2>
                <span class="close" onclick="closeMediaModal()">&times;</span>
            </div>
            <div class="media-detail">
                <div class="media-preview" id="mediaPreview">
                    <!-- ë¯¸ë””ì–´ ë¯¸ë¦¬ë³´ê¸° -->
                </div>
                <div class="media-info" id="mediaInfo">
                    <!-- ë¯¸ë””ì–´ ì •ë³´ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="admin-btn admin-btn-secondary" onclick="closeMediaModal()">ë‹«ê¸°</button>
                <button type="button" class="admin-btn admin-btn-danger" onclick="deleteCurrentMedia()">ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <script>
        let mediaFiles = [];
        let filteredMedia = [];
        let currentMediaId = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadMedia();
        });

        function checkAdminAuth() {
            const token = localStorage.getItem('adminToken');
            const user = JSON.parse(localStorage.getItem('adminUser') || '{}');
            
            if (!token || user.role !== 'admin') {
                window.location.href = './login.html';
                return;
            }
            
            document.getElementById('adminUserName').textContent = user.name || 'ê´€ë¦¬ì';
        }

        async function loadMedia() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/media', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ë¯¸ë””ì–´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                mediaFiles = await response.json();
                filteredMedia = [...mediaFiles];
                renderMedia();

            } catch (error) {
                console.error('ë¯¸ë””ì–´ ë¡œë”© ì˜¤ë¥˜:', error);
                showError('ë¯¸ë””ì–´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function renderMedia() {
            const grid = document.getElementById('mediaGrid');
            
            if (filteredMedia.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #666; grid-column: 1 / -1;">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            grid.innerHTML = filteredMedia.map(media => `
                <div class="media-card" onclick="showMediaDetail(${media.id})">
                    <div class="media-thumbnail">
                        ${media.type === 'image' ? 
                            `<img src="${media.filePath}" alt="${media.description || 'ì´ë¯¸ì§€'}" />` :
                            `<video src="${media.filePath}" preload="metadata"></video>`
                        }
                        <div class="media-type-badge">${media.type === 'image' ? 'ğŸ“·' : 'ğŸ¬'}</div>
                    </div>
                    <div class="media-info">
                        <div class="media-title">${media.originalName}</div>
                        <div class="media-meta">
                            <small>${formatFileSize(media.fileSize)} â€¢ ${formatDate(media.createdAt)}</small>
                        </div>
                        <div class="media-description">${media.description || 'ì„¤ëª… ì—†ìŒ'}</div>
                    </div>
                </div>
            `).join('');
        }

        function filterMedia() {
            const typeFilter = document.getElementById('typeFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            filteredMedia = mediaFiles.filter(media => {
                const matchesType = !typeFilter || media.type === typeFilter;
                const matchesSearch = !searchInput || 
                    media.originalName.toLowerCase().includes(searchInput) || 
                    (media.description && media.description.toLowerCase().includes(searchInput));

                return matchesType && matchesSearch;
            });

            renderMedia();
        }

        function showUploadModal() {
            document.getElementById('uploadForm').reset();
            document.getElementById('uploadModal').style.display = 'block';
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
        }

        async function uploadFile(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const description = document.getElementById('modalDescription').value;
            
            if (!fileInput.files[0]) {
                showError('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const formData = new FormData();
            formData.append('media', fileInput.files[0]);
            formData.append('description', description);

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/media', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                closeUploadModal();
                loadMedia();
                showSuccess('íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                showError(error.message);
            }
        }

        function showMediaDetail(mediaId) {
            const media = mediaFiles.find(m => m.id === mediaId);
            if (!media) return;

            currentMediaId = mediaId;
            document.getElementById('mediaModalTitle').textContent = media.originalName;
            
            const preview = document.getElementById('mediaPreview');
            if (media.type === 'image') {
                preview.innerHTML = `<img src="${media.filePath}" alt="${media.description || 'ì´ë¯¸ì§€'}" style="max-width: 100%; height: auto;" />`;
            } else {
                preview.innerHTML = `<video src="${media.filePath}" controls style="max-width: 100%; height: auto;"></video>`;
            }

            const info = document.getElementById('mediaInfo');
            info.innerHTML = `
                <p><strong>íŒŒì¼ëª…:</strong> ${media.originalName}</p>
                <p><strong>íƒ€ì…:</strong> ${media.type === 'image' ? 'ì´ë¯¸ì§€' : 'ë™ì˜ìƒ'}</p>
                <p><strong>í¬ê¸°:</strong> ${formatFileSize(media.fileSize)}</p>
                <p><strong>ì—…ë¡œë“œì¼:</strong> ${formatDate(media.createdAt)}</p>
                <p><strong>ì—…ë¡œë”:</strong> ${media.uploader ? media.uploader.name : 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                <p><strong>ì„¤ëª…:</strong> ${media.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                <p><strong>ê²½ë¡œ:</strong> <code>${media.filePath}</code></p>
            `;

            document.getElementById('mediaModal').style.display = 'block';
        }

        function closeMediaModal() {
            document.getElementById('mediaModal').style.display = 'none';
            currentMediaId = null;
        }

        async function deleteCurrentMedia() {
            if (!currentMediaId || !confirm('ì •ë§ë¡œ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/media/${currentMediaId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                closeMediaModal();
                loadMedia();
                showSuccess('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                console.error('íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
                showError('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = './login.html';
            }
        }

        function showError(message) {
            alert('ì˜¤ë¥˜: ' + message);
        }

        function showSuccess(message) {
            alert(message);
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const uploadModal = document.getElementById('uploadModal');
            const mediaModal = document.getElementById('mediaModal');
            if (event.target === uploadModal) {
                closeUploadModal();
            }
            if (event.target === mediaModal) {
                closeMediaModal();
            }
        }
    </script>

    <style>
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .media-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .media-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .media-thumbnail {
            position: relative;
            height: 150px;
            overflow: hidden;
        }

        .media-thumbnail img,
        .media-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-type-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .media-info {
            padding: 12px;
        }

        .media-title {
            font-weight: bold;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .media-meta {
            color: #666;
            margin-bottom: 8px;
        }

        .media-description {
            font-size: 14px;
            color: #888;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .media-detail {
            display: flex;
            gap: 20px;
        }

        .media-preview {
            flex: 1;
            max-width: 60%;
        }

        .media-info {
            flex: 1;
            max-width: 40%;
        }

        .modal-large {
            max-width: 800px;
        }
    </style>
</body>
</html>