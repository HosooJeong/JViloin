<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - J-Violin</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="../../css/admin.css">
</head>
<body class="admin-dashboard">
    <header class="admin-header">
        <nav class="admin-nav">
            <h1>ğŸ¼ J-Violin ê´€ë¦¬ì</h1>
            <ul class="admin-nav-menu">
                <li><a href="./dashboard.html" class="active">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="./users.html">ì‚¬ìš©ì ê´€ë¦¬</a></li>
                <li><a href="./schedules.html">ì‹œê°„í‘œ ê´€ë¦¬</a></li>
                <li><a href="./posts.html">ê²Œì‹œíŒ ê´€ë¦¬</a></li>
                <li><a href="./media.html">ê°¤ëŸ¬ë¦¬ ê´€ë¦¬</a></li>
                <li><a href="./reservations.html">ì˜ˆì•½ ê´€ë¦¬</a></li>
            </ul>
            <div class="admin-user-info">
                <span id="adminUserName">ê´€ë¦¬ì</span>
                <button class="admin-btn admin-btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </nav>
    </header>

    <main class="admin-container">
        <h1 class="admin-page-title">ëŒ€ì‹œë³´ë“œ</h1>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label">ì´ í•™ìƒ ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalTeachers">0</div>
                <div class="stat-label">ì´ ê°•ì‚¬ ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalSchedules">0</div>
                <div class="stat-label">í™œì„± ìŠ¤ì¼€ì¤„</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalPosts">0</div>
                <div class="stat-label">ë°œí–‰ëœ ê²Œì‹œê¸€</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalMedia">0</div>
                <div class="stat-label">ê°¤ëŸ¬ë¦¬ í•­ëª©</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="confirmedReservations">0</div>
                <div class="stat-label">í™•ì •ëœ ì˜ˆì•½</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingReservations">0</div>
                <div class="stat-label">ëŒ€ê¸° ì¤‘ ì˜ˆì•½</div>
            </div>
        </div>

        <!-- ìµœê·¼ ê°€ì…í•œ ì‚¬ìš©ì -->
        <div class="admin-table-container">
            <h3 style="padding: 20px 20px 0; margin: 0; color: #333;">ìµœê·¼ ê°€ì…í•œ ì‚¬ìš©ì</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ì‚¬ìš©ìëª…</th>
                        <th>ì´ë¦„</th>
                        <th>ì—­í• </th>
                        <th>ê°€ì…ì¼</th>
                    </tr>
                </thead>
                <tbody id="recentUsersTable">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666;">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <br>

        <!-- ìµœê·¼ ì˜ˆì•½ -->
        <div class="admin-table-container">
            <h3 style="padding: 20px 20px 0; margin: 0; color: #333;">ìµœê·¼ ì˜ˆì•½</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>í•™ìƒ</th>
                        <th>ìˆ˜ì—…</th>
                        <th>ì˜ˆì•½ì¼</th>
                        <th>ìƒíƒœ</th>
                        <th>ë“±ë¡ì¼</th>
                    </tr>
                </thead>
                <tbody id="recentReservationsTable">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #666;">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadDashboardData();
        });

        function checkAdminAuth() {
            const token = localStorage.getItem('adminToken');
            const user = JSON.parse(localStorage.getItem('adminUser') || '{}');
            
            if (!token || user.role !== 'admin') {
                window.location.href = './login.html';
                return;
            }
            
            document.getElementById('adminUserName').textContent = user.name || 'ê´€ë¦¬ì';
        }

        async function loadDashboardData() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const data = await response.json();
                updateStats(data.stats);
                updateRecentUsers(data.recentUsers);
                updateRecentReservations(data.recentReservations);

            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
                showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function updateStats(stats) {
            document.getElementById('totalStudents').textContent = stats.totalStudents;
            document.getElementById('totalTeachers').textContent = stats.totalTeachers;
            document.getElementById('totalSchedules').textContent = stats.totalSchedules;
            document.getElementById('totalPosts').textContent = stats.totalPosts;
            document.getElementById('totalMedia').textContent = stats.totalMedia;
            document.getElementById('confirmedReservations').textContent = stats.confirmedReservations;
            document.getElementById('pendingReservations').textContent = stats.pendingReservations;
        }

        function updateRecentUsers(users) {
            const tbody = document.getElementById('recentUsersTable');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">ìµœê·¼ ê°€ì…í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.name}</td>
                    <td><span class="status-badge status-${user.role}">${getRoleText(user.role)}</span></td>
                    <td>${formatDate(user.createdAt)}</td>
                </tr>
            `).join('');
        }

        function updateRecentReservations(reservations) {
            const tbody = document.getElementById('recentReservationsTable');
            
            if (reservations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">ìµœê·¼ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = reservations.map(reservation => `
                <tr>
                    <td>${reservation.user.name}</td>
                    <td>${reservation.schedule.courseName}<br><small>${reservation.schedule.timeSlot}</small></td>
                    <td>${formatDate(reservation.reservationDate)}</td>
                    <td><span class="status-badge status-${reservation.status}">${getStatusText(reservation.status)}</span></td>
                    <td>${formatDate(reservation.createdAt)}</td>
                </tr>
            `).join('');
        }

        function getRoleText(role) {
            const roleMap = {
                'student': 'í•™ìƒ',
                'teacher': 'ê°•ì‚¬',
                'admin': 'ê´€ë¦¬ì'
            };
            return roleMap[role] || role;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'ëŒ€ê¸°',
                'confirmed': 'í™•ì •',
                'cancelled': 'ì·¨ì†Œ',
                'completed': 'ì™„ë£Œ'
            };
            return statusMap[status] || status;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = './login.html';
            }
        }

        function showError(message) {
            alert(message); // ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë” ë‚˜ì€ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‚¬ìš©
        }
    </script>
</body>
</html>