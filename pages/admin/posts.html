<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œíŒ ê´€ë¦¬ - J-Violin ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="../../css/admin.css">
</head>
<body class="admin-dashboard">
    <header class="admin-header">
        <nav class="admin-nav">
            <h1>ğŸ¼ J-Violin ê´€ë¦¬ì</h1>
            <ul class="admin-nav-menu">
                <li><a href="./dashboard.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="./users.html">ì‚¬ìš©ì ê´€ë¦¬</a></li>
                <li><a href="./schedules.html">ì‹œê°„í‘œ ê´€ë¦¬</a></li>
                <li><a href="./posts.html" class="active">ê²Œì‹œíŒ ê´€ë¦¬</a></li>
                <li><a href="./media.html">ê°¤ëŸ¬ë¦¬ ê´€ë¦¬</a></li>
                <li><a href="./reservations.html">ì˜ˆì•½ ê´€ë¦¬</a></li>
            </ul>
            <div class="admin-user-info">
                <span id="adminUserName">ê´€ë¦¬ì</span>
                <button class="admin-btn admin-btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </nav>
    </header>

    <main class="admin-container">
        <div class="admin-page-header">
            <h1 class="admin-page-title">ê²Œì‹œíŒ ê´€ë¦¬</h1>
            <button class="admin-btn admin-btn-primary" onclick="showCreatePostModal()">ìƒˆ ê²Œì‹œê¸€ ì‘ì„±</button>
        </div>

        <!-- í•„í„° -->
        <div class="admin-filters">
            <div class="filter-group">
                <label for="categoryFilter">ì¹´í…Œê³ ë¦¬:</label>
                <select id="categoryFilter" onchange="filterPosts()">
                    <option value="">ì „ì²´</option>
                    <option value="notice">ê³µì§€ì‚¬í•­</option>
                    <option value="news">ì†Œì‹</option>
                    <option value="event">ì´ë²¤íŠ¸</option>
                    <option value="general">ì¼ë°˜</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchInput">ê²€ìƒ‰:</label>
                <input type="text" id="searchInput" placeholder="ì œëª© ë˜ëŠ” ë‚´ìš© ê²€ìƒ‰" onkeyup="filterPosts()">
            </div>
        </div>

        <!-- ê²Œì‹œê¸€ í…Œì´ë¸” -->
        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ì œëª©</th>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>ì‘ì„±ì</th>
                        <th>ì¡°íšŒìˆ˜</th>
                        <th>ì‘ì„±ì¼</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="postsTable">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- ê²Œì‹œê¸€ ìƒì„±/í¸ì§‘ ëª¨ë‹¬ -->
    <div id="postModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="modalTitle">ìƒˆ ê²Œì‹œê¸€ ì‘ì„±</h2>
                <span class="close" onclick="closePostModal()">&times;</span>
            </div>
            <form id="postForm" onsubmit="savePost(event)">
                <div class="form-group">
                    <label for="modalTitle">ì œëª©:</label>
                    <input type="text" id="modalPostTitle" required>
                </div>
                <div class="form-group">
                    <label for="modalCategory">ì¹´í…Œê³ ë¦¬:</label>
                    <select id="modalCategory" required>
                        <option value="notice">ê³µì§€ì‚¬í•­</option>
                        <option value="news">ì†Œì‹</option>
                        <option value="event">ì´ë²¤íŠ¸</option>
                        <option value="general">ì¼ë°˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modalContent">ë‚´ìš©:</label>
                    <textarea id="modalContent" rows="10" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="admin-btn admin-btn-secondary" onclick="closePostModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="admin-btn admin-btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let posts = [];
        let filteredPosts = [];
        let editingPostId = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadPosts();
        });

        function checkAdminAuth() {
            const token = localStorage.getItem('adminToken');
            const user = JSON.parse(localStorage.getItem('adminUser') || '{}');
            
            if (!token || user.role !== 'admin') {
                window.location.href = './login.html';
                return;
            }
            
            document.getElementById('adminUserName').textContent = user.name || 'ê´€ë¦¬ì';
        }

        async function loadPosts() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/posts', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ê²Œì‹œê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                posts = await response.json();
                filteredPosts = [...posts];
                renderPosts();

            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë”© ì˜¤ë¥˜:', error);
                showError('ê²Œì‹œê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function renderPosts() {
            const tbody = document.getElementById('postsTable');
            
            if (filteredPosts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredPosts.map(post => `
                <tr>
                    <td>${post.id}</td>
                    <td><a href="javascript:void(0)" onclick="viewPost(${post.id})" style="color: #007bff; text-decoration: none;">${post.title}</a></td>
                    <td><span class="status-badge status-${post.category}">${getCategoryText(post.category)}</span></td>
                    <td>${post.author ? post.author.name : 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                    <td>${post.views || 0}</td>
                    <td>${formatDate(post.createdAt)}</td>
                    <td>
                        <button class="admin-btn admin-btn-small" onclick="editPost(${post.id})">í¸ì§‘</button>
                        <button class="admin-btn admin-btn-small admin-btn-danger" onclick="deletePost(${post.id})">ì‚­ì œ</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterPosts() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            filteredPosts = posts.filter(post => {
                const matchesCategory = !categoryFilter || post.category === categoryFilter;
                const matchesSearch = !searchInput || 
                    post.title.toLowerCase().includes(searchInput) || 
                    post.content.toLowerCase().includes(searchInput);

                return matchesCategory && matchesSearch;
            });

            renderPosts();
        }

        function showCreatePostModal() {
            editingPostId = null;
            document.getElementById('modalTitle').textContent = 'ìƒˆ ê²Œì‹œê¸€ ì‘ì„±';
            document.getElementById('postForm').reset();
            document.getElementById('postModal').style.display = 'block';
        }

        function editPost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;

            editingPostId = postId;
            document.getElementById('modalTitle').textContent = 'ê²Œì‹œê¸€ í¸ì§‘';
            document.getElementById('modalPostTitle').value = post.title;
            document.getElementById('modalCategory').value = post.category;
            document.getElementById('modalContent').value = post.content;
            document.getElementById('postModal').style.display = 'block';
        }

        function viewPost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;

            alert(`ì œëª©: ${post.title}\n\në‚´ìš©:\n${post.content}`);
        }

        function closePostModal() {
            document.getElementById('postModal').style.display = 'none';
            editingPostId = null;
        }

        async function savePost(event) {
            event.preventDefault();
            
            const formData = {
                title: document.getElementById('modalPostTitle').value,
                category: document.getElementById('modalCategory').value,
                content: document.getElementById('modalContent').value
            };

            try {
                const token = localStorage.getItem('adminToken');
                const url = editingPostId ? `/api/admin/posts/${editingPostId}` : '/api/admin/posts';
                const method = editingPostId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'ê²Œì‹œê¸€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                closePostModal();
                loadPosts();
                showSuccess(editingPostId ? 'ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                console.error('ê²Œì‹œê¸€ ì €ì¥ ì˜¤ë¥˜:', error);
                showError(error.message);
            }
        }

        async function deletePost(postId) {
            if (!confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/posts/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                loadPosts();
                showSuccess('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                console.error('ê²Œì‹œê¸€ ì‚­ì œ ì˜¤ë¥˜:', error);
                showError('ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function getCategoryText(category) {
            const categoryMap = {
                'notice': 'ê³µì§€ì‚¬í•­',
                'news': 'ì†Œì‹',
                'event': 'ì´ë²¤íŠ¸',
                'general': 'ì¼ë°˜'
            };
            return categoryMap[category] || category;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = './login.html';
            }
        }

        function showError(message) {
            alert('ì˜¤ë¥˜: ' + message);
        }

        function showSuccess(message) {
            alert(message);
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('postModal');
            if (event.target === modal) {
                closePostModal();
            }
        }
    </script>
</body>
</html>