<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ˆì•½ ê´€ë¦¬ - J-Violin ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="../../css/admin.css">
</head>
<body class="admin-dashboard">
    <header class="admin-header">
        <nav class="admin-nav">
            <h1>ğŸ¼ J-Violin ê´€ë¦¬ì</h1>
            <ul class="admin-nav-menu">
                <li><a href="./dashboard.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="./users.html">ì‚¬ìš©ì ê´€ë¦¬</a></li>
                <li><a href="./schedules.html">ì‹œê°„í‘œ ê´€ë¦¬</a></li>
                <li><a href="./posts.html">ê²Œì‹œíŒ ê´€ë¦¬</a></li>
                <li><a href="./media.html">ê°¤ëŸ¬ë¦¬ ê´€ë¦¬</a></li>
                <li><a href="./reservations.html" class="active">ì˜ˆì•½ ê´€ë¦¬</a></li>
            </ul>
            <div class="admin-user-info">
                <span id="adminUserName">ê´€ë¦¬ì</span>
                <button class="admin-btn admin-btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </nav>
    </header>

    <main class="admin-container">
        <div class="admin-page-header">
            <h1 class="admin-page-title">ì˜ˆì•½ ê´€ë¦¬</h1>
        </div>

        <!-- í•„í„° -->
        <div class="admin-filters">
            <div class="filter-group">
                <label for="statusFilter">ìƒíƒœ:</label>
                <select id="statusFilter" onchange="filterReservations()">
                    <option value="">ì „ì²´</option>
                    <option value="pending">ëŒ€ê¸°</option>
                    <option value="confirmed">í™•ì •</option>
                    <option value="cancelled">ì·¨ì†Œ</option>
                    <option value="completed">ì™„ë£Œ</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="dateFilter">ì˜ˆì•½ì¼:</label>
                <input type="date" id="dateFilter" onchange="filterReservations()">
            </div>
            <div class="filter-group">
                <label for="searchInput">ê²€ìƒ‰:</label>
                <input type="text" id="searchInput" placeholder="í•™ìƒëª… ë˜ëŠ” ìˆ˜ì—…ëª… ê²€ìƒ‰" onkeyup="filterReservations()">
            </div>
        </div>

        <!-- ì˜ˆì•½ í…Œì´ë¸” -->
        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>í•™ìƒ</th>
                        <th>ìˆ˜ì—…</th>
                        <th>ê°•ì‚¬</th>
                        <th>ì˜ˆì•½ì¼</th>
                        <th>ì‹œê°„</th>
                        <th>ìƒíƒœ</th>
                        <th>ë“±ë¡ì¼</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="reservationsTable">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #666;">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        let reservations = [];
        let filteredReservations = [];

        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadReservations();
        });

        function checkAdminAuth() {
            const token = localStorage.getItem('adminToken');
            const user = JSON.parse(localStorage.getItem('adminUser') || '{}');
            
            if (!token || user.role !== 'admin') {
                window.location.href = './login.html';
                return;
            }
            
            document.getElementById('adminUserName').textContent = user.name || 'ê´€ë¦¬ì';
        }

        async function loadReservations() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/reservations', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                reservations = await response.json();
                filteredReservations = [...reservations];
                renderReservations();

            } catch (error) {
                console.error('ì˜ˆì•½ ë¡œë”© ì˜¤ë¥˜:', error);
                showError('ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function renderReservations() {
            const tbody = document.getElementById('reservationsTable');
            
            if (filteredReservations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredReservations.map(reservation => `
                <tr>
                    <td>${reservation.id}</td>
                    <td>${reservation.user ? reservation.user.name : 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                    <td>${reservation.schedule ? reservation.schedule.courseName : 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                    <td>${reservation.schedule && reservation.schedule.teacher ? reservation.schedule.teacher.name : 'ë¯¸ë°°ì •'}</td>
                    <td>${formatDate(reservation.reservationDate)}</td>
                    <td>${reservation.schedule ? reservation.schedule.timeSlot : '-'}</td>
                    <td><span class="status-badge status-${reservation.status}">${getStatusText(reservation.status)}</span></td>
                    <td>${formatDate(reservation.createdAt)}</td>
                    <td>
                        ${reservation.status === 'pending' ? 
                            `<button class="admin-btn admin-btn-small admin-btn-success" onclick="updateReservationStatus(${reservation.id}, 'confirmed')">ìŠ¹ì¸</button>
                             <button class="admin-btn admin-btn-small admin-btn-danger" onclick="updateReservationStatus(${reservation.id}, 'cancelled')">ê±°ì ˆ</button>` :
                            reservation.status === 'confirmed' ?
                            `<button class="admin-btn admin-btn-small" onclick="updateReservationStatus(${reservation.id}, 'completed')">ì™„ë£Œ</button>
                             <button class="admin-btn admin-btn-small admin-btn-danger" onclick="updateReservationStatus(${reservation.id}, 'cancelled')">ì·¨ì†Œ</button>` :
                            '<span style="color: #666;">-</span>'
                        }
                    </td>
                </tr>
            `).join('');
        }

        function filterReservations() {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            filteredReservations = reservations.filter(reservation => {
                const matchesStatus = !statusFilter || reservation.status === statusFilter;
                const matchesDate = !dateFilter || reservation.reservationDate.startsWith(dateFilter);
                const matchesSearch = !searchInput || 
                    (reservation.user && reservation.user.name.toLowerCase().includes(searchInput)) || 
                    (reservation.schedule && reservation.schedule.courseName.toLowerCase().includes(searchInput));

                return matchesStatus && matchesDate && matchesSearch;
            });

            renderReservations();
        }

        async function updateReservationStatus(reservationId, newStatus) {
            const statusText = getStatusText(newStatus);
            if (!confirm(`ì´ ì˜ˆì•½ì„ "${statusText}" ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/reservations/${reservationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'ì˜ˆì•½ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                loadReservations();
                showSuccess(`ì˜ˆì•½ì´ "${statusText}" ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);

            } catch (error) {
                console.error('ì˜ˆì•½ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                showError(error.message);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'ëŒ€ê¸°',
                'confirmed': 'í™•ì •',
                'cancelled': 'ì·¨ì†Œ',
                'completed': 'ì™„ë£Œ'
            };
            return statusMap[status] || status;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = './login.html';
            }
        }

        function showError(message) {
            alert('ì˜¤ë¥˜: ' + message);
        }

        function showSuccess(message) {
            alert(message);
        }
    </script>

    <style>
        .admin-btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }

        .admin-btn-success:hover {
            background-color: #218838;
        }
    </style>
</body>
</html>